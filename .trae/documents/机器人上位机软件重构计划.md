# 机器人上位机软件重构计划

## 1. 整体架构设计

采用面向对象设计模式，将不同功能模块封装为独立的类，实现高内聚、低耦合的代码结构。

### 1.1 文件结构
```
Client/
├── main.py                    # 主程序入口
├── ui/
│   ├── main_window.py         # 主窗口UI设计
│   └── ui_main_window.py      # PyQt生成的UI文件
├── core/
│   ├── communication.py       # TCP通信模块
│   ├── config_manager.py      # 配置管理模块
│   ├── data_processor.py      # 数据处理模块
│   ├── file_handler.py        # 文件处理模块
│   ├── fuzzy_logic.py         # 模糊逻辑处理模块
│   └── logger.py              # 日志模块
├── resources/
│   └── config.ini             # 配置文件
└── README.md                  # 项目说明文档
```

### 1.2 核心类设计

| 类名 | 功能描述 |
|------|----------|
| `MainWindow` | 主窗口类，负责UI交互和整体控制 |
| `TCPCommunication` | TCP通信类，负责与机器人服务器通信 |
| `ConfigManager` | 配置管理类，处理配置文件的读写 |
| `DataProcessor` | 数据处理类，包括重量获取和抖动参数计算 |
| `FileHandler` | 文件处理类，处理Excel和JSON文件 |
| `FuzzyLogicEngine` | 模糊逻辑引擎，实现模糊推理 |
| `Logger` | 日志管理类，记录程序运行日志 |

## 2. 功能模块设计

### 2.1 TCP通信模块
- 实现TCP连接的建立、断开、发送和接收
- 支持超时处理和异常捕获
- 提供异步通信机制，避免界面卡顿

### 2.2 配置管理模块
- 支持从配置文件读取IP地址、端口、文件路径等配置
- 支持运行时修改配置并保存
- 提供默认配置值

### 2.3 数据处理模块
- 重量数据获取（支持模拟和真实串口数据）
- 抖动参数计算（基于差值百分比和密度、颗粒大小）
- 数据验证和格式化

### 2.4 文件处理模块
- Excel文件读取（目标重量数据）
- JSON文件保存（实验结果数据）
- 支持多种文件格式

### 2.5 模糊逻辑模块
- 实现模糊域和模糊集合的定义
- 支持模糊规则的配置
- 实现模糊推理和去模糊化

### 2.6 日志模块
- 支持文件日志和控制台日志
- 可配置日志级别
- 详细记录程序运行状态和关键数据

## 3. 界面设计

### 3.1 主界面布局
- **连接设置区域**：显示连接状态，提供连接/断开按钮，配置IP地址和端口
- **参数配置区域**：配置密度、颗粒大小、瓶重等参数
- **数据显示区域**：实时显示目标重量、当前重量、抖动参数等
- **文件操作区域**：选择Excel文件，显示文件内容预览
- **日志显示区域**：实时显示程序运行日志
- **控制区域**：提供开始/停止按钮，控制程序运行

### 3.2 界面功能
- 支持实时数据刷新
- 提供参数调整的滑块和输入框
- 支持日志级别切换
- 提供数据导出功能
- 支持异常信息弹窗提示

## 4. 代码优化策略

### 4.1 消除代码重复
- 将重复的导入和模糊逻辑代码提取为独立模块
- 统一TCP通信框架
- 实现通用的工具函数

### 4.2 配置管理优化
- 使用配置文件管理配置信息
- 支持命令行参数覆盖配置
- 实现配置验证

### 4.3 异常处理优化
- 实现细粒度的异常捕获
- 添加异常重试机制
- 提供用户友好的错误提示

### 4.4 性能优化
- 使用异步通信避免界面卡顿
- 优化文件读写操作
- 实现数据缓存机制

## 5. 实施步骤

1. 创建项目目录结构
2. 实现核心工具模块（logger.py, config_manager.py）
3. 实现TCP通信模块
4. 实现数据处理和模糊逻辑模块
5. 实现文件处理模块
6. 设计和实现主界面
7. 整合各模块，实现主程序逻辑
8. 测试和调试
9. 优化代码和界面
10. 编写文档

## 6. 技术栈

- **编程语言**：Python 3.8+
- **GUI框架**：PyQt 5
- **通信协议**：TCP/IP Socket
- **文件处理**：openpyxl, json
- **模糊逻辑**：fuzzylogic
- **日志**：logging
- **配置管理**：configparser

## 7. 预期效果

- 统一的用户界面，操作直观方便
- 模块化的代码结构，易于维护和扩展
- 完善的异常处理，提高程序稳定性
- 支持配置管理，便于部署和使用
- 详细的日志记录，便于调试和问题定位
- 支持模拟数据和真实数据切换，便于测试和生产使用

这个重构计划将实现一个功能完整、结构清晰、易于维护的机器人上位机软件，满足用户的需求。